/**
 * ===================================
 * CHAT ASSISTANT - MAIN
 * Controlador principal del chat con IA
 * ===================================
 */

class ChatAssistant {
  constructor(config = {}) {
    this.config = {
      apiKey: config.apiKey || null,
      containerId: config.containerId || 'chat-assistant',
      position: config.position || 'bottom-right',
      autoOpen: config.autoOpen || false,
      maxMessages: config.maxMessages || 50,
      ...config
    };

    this.isOpen = false;
    this.isLoading = false;
    this.conversation = [];
    this.groqAPI = null;
    this.raven = null;
    this.elements = {};

    this.quickActions = [
      "CV",
      "Contacto", 
      "Info"
    ];

    this.init();
  }

  /**
   * Inicializar el chat assistant
   */
  async init() {
    this.createElements();
    this.setupEventListeners();
    await this.initializeAPI();
    this.initializeRaven();
    this.addWelcomeMessage();
    
    if (this.config.autoOpen) {
      setTimeout(() => this.openChat(), 2000);
    }

    console.log('üí¨ Chat Assistant initialized');
  }

  /**
   * Crear elementos del chat (SIN BOT√ìN - el cuervo es el bot√≥n)
   */
  createElements() {
    // VERIFICAR si ya existe para evitar duplicados
    const existingContainer = document.getElementById(this.config.containerId);
    if (existingContainer) {
      console.log('‚ö†Ô∏è Chat container already exists, removing old one');
      existingContainer.remove();
    }

    // Container principal
    const container = document.createElement('div');
    container.id = this.config.containerId;
    container.className = 'chat-assistant';

    // Solo la ventana de chat (SIN bot√≥n toggle)
    const chatWindow = document.createElement('div');
    chatWindow.className = 'chat-window';
    chatWindow.innerHTML = this.getChatHTML();

    container.appendChild(chatWindow);
    document.body.appendChild(container);

    // Referencias a elementos
    this.elements = {
      container,
      chatWindow,
      messages: chatWindow.querySelector('.chat-messages'),
      input: chatWindow.querySelector('.chat-input'),
      sendBtn: chatWindow.querySelector('.chat-send-btn'),
      inputContainer: chatWindow.querySelector('.chat-input-container'),
      quickActions: chatWindow.querySelector('.chat-quick-actions'),
      closeBtn: chatWindow.querySelector('.chat-close-btn')
    };

    // üîç DEBUG: Verificar elementos creados
    console.log('üîç DEBUG - Elementos creados:', {
      container: container.id,
      inputContainer: this.elements.inputContainer ? 'EXISTS' : 'NOT FOUND',
      input: this.elements.input ? 'EXISTS' : 'NOT FOUND',
      sendBtn: this.elements.sendBtn ? 'EXISTS' : 'NOT FOUND',
      inputContainerChildren: this.elements.inputContainer ? this.elements.inputContainer.children.length : 0
    });

    // üîç DEBUG: Verificar posici√≥n de elementos
    setTimeout(() => {
      const allInputContainers = document.querySelectorAll('.chat-input-container');
      const allInputs = document.querySelectorAll('.chat-input');
      const allSendBtns = document.querySelectorAll('.chat-send-btn');
      
      console.log('üîç DEBUG - Elementos en DOM:', {
        inputContainers: allInputContainers.length,
        inputs: allInputs.length,
        sendBtns: allSendBtns.length
      });

      // Mostrar posici√≥n de cada elemento
      allInputs.forEach((input, i) => {
        const rect = input.getBoundingClientRect();
        console.log(`üîç Input ${i}:`, { top: rect.top, left: rect.left, parent: input.parentElement?.className });
      });

      allSendBtns.forEach((btn, i) => {
        const rect = btn.getBoundingClientRect();
        console.log(`üîç SendBtn ${i}:`, { top: rect.top, left: rect.left, parent: btn.parentElement?.className });
      });
    }, 500);
  }

  /**
   * Obtener HTML del chat
   */
  getChatHTML() {
    return `
      <div class="chat-header">
        <div class="chat-avatar">üê¶‚Äç‚¨õ</div>
        <div class="chat-info">
          <h3>Edgar AI</h3>
          <p>Asistente de BI & Data Science</p>
        </div>
        <div class="chat-status"></div>
        <button class="chat-close-btn" type="button">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18"></path>
            <path d="M6 6L18 18"></path>
          </svg>
        </button>
      </div>

      <div class="chat-quick-actions">
        ${this.quickActions.map(action => 
          `<button class="quick-action-btn" data-action="${action}">${action}</button>`
        ).join('')}
      </div>

      <div class="chat-messages">
      </div>

      <div class="chat-input-container">
        <textarea class="chat-input" placeholder="Escribe tu pregunta..." rows="1"></textarea>
        <button class="chat-send-btn" type="button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 2L11 13"></path>
            <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
          </svg>
        </button>
      </div>
    `;
  }

  /**
   * Configurar event listeners
   */
  setupEventListeners() {
    // Bot√≥n de cerrar
    this.elements.closeBtn.addEventListener('click', () => this.closeChat());

    // Enviar mensaje
    this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
    
    // Enter para enviar
    this.elements.input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        this.sendMessage();
      }
    });

    // Auto-resize textarea
    this.elements.input.addEventListener('input', () => {
      this.autoResizeTextarea();
    });

    // Quick actions - Llamar funciones directamente
    this.elements.quickActions.addEventListener('click', (e) => {
      if (e.target.classList.contains('quick-action-btn')) {
        const action = e.target.dataset.action;
        
        // Agregar mensaje del usuario
        this.addMessage(action, 'user');
        
        // Ejecutar acci√≥n espec√≠fica
        let response;
        if (action === 'CV') {
          response = this.handleCVDownload();
        } else if (action === 'Contacto') {
          response = this.handleContactInfo();
        } else if (action === 'Info') {
          response = this.handleEdgarInfo();
        } else {
          // Fallback para otras acciones
          response = this.getFallbackResponse(action);
        }
        
        // Mostrar respuesta
        this.addMessage(response, 'assistant');
      }
    });

    // Cerrar con Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && this.isOpen) {
        this.closeChat();
      }
    });
  }

  /**
   * Inicializar API de Groq
   */
  async initializeAPI() {
    console.log('üîß Inicializando API...');
    
    // Obtener API key (puede ser as√≠ncrona)
    const apiKey = await getAPIKey();
    
    console.log('üîç API Key check:', {
      hasApiKey: !!apiKey,
      apiKeyLength: apiKey?.length,
      hasGroqAPI: !!window.GroqAPI
    });
    
    if (apiKey && window.GroqAPI) {
      this.config.apiKey = apiKey;
      this.groqAPI = new window.GroqAPI(apiKey);
      console.log('‚úÖ Groq API initialized con key:', apiKey.substring(0, 10) + '...');
    } else {
      console.warn('‚ö†Ô∏è Groq API key not provided or GroqAPI not loaded', {
        apiKey: !!apiKey,
        GroqAPI: !!window.GroqAPI
      });
    }
  }

  /**
   * Agregar mensaje de bienvenida mejorado
   */
  addWelcomeMessage() {
    const welcomeMessage = "¬°Hola! üëã Soy Edgar AI, ¬øen qu√© te puedo ayudar?\n\n‚ùì Preguntas frecuentes:\n‚Ä¢ ¬øQu√© proyectos has hecho?\n‚Ä¢ ¬øCu√°nto cobras por un dashboard?\n‚Ä¢ ¬øEst√°s disponible para trabajar?\n‚Ä¢ ¬øQu√© experiencia tienes en Power BI?";
    this.addMessage(welcomeMessage, 'assistant');
  }

  /**
   * Inicializar cuervo compa√±ero
   */
  initializeRaven() {
    if (window.RavenCompanion) {
      this.raven = new window.RavenCompanion();
      console.log('üê¶‚Äç‚¨õ Raven Companion initialized');
    } else {
      console.warn('‚ö†Ô∏è RavenCompanion not loaded');
    }
  }

  /**
   * Abrir/cerrar chat
   */
  toggleChat() {
    if (this.isOpen) {
      this.closeChat();
    } else {
      this.openChat();
    }
  }

  /**
   * Abrir chat
   */
  openChat() {
    this.isOpen = true;
    this.elements.chatWindow.classList.add('active');
    this.elements.input.focus();
    
    // Notificar al cuervo
    if (this.raven) {
      this.raven.onChatEvent('chat_opened');
    }
  }

  /**
   * Cerrar chat
   */
  closeChat() {
    this.isOpen = false;
    this.elements.chatWindow.classList.remove('active');
    
    // Notificar al cuervo
    if (this.raven) {
      this.raven.onChatEvent('chat_closed');
    }
  }

  /**
   * Enviar mensaje
   */
  async sendMessage(text = null) {
    const message = text || this.elements.input.value.trim();
    
    if (!message || this.isLoading) return;

    // Limpiar input
    this.elements.input.value = '';
    this.autoResizeTextarea();

    // Agregar mensaje del usuario
    this.addMessage(message, 'user');

    // Las opciones se mantienen visibles siempre (comentado)
    // this.elements.quickActions.style.display = 'none';

    // Mostrar typing indicator
    this.showTypingIndicator();
    this.setLoading(true);

    // Notificar al cuervo
    if (this.raven) {
      this.raven.onChatEvent('message_sent');
    }

    try {
      let response;
      
      console.log('üöÄ Enviando mensaje...', {
        hasGroqAPI: !!this.groqAPI,
        isConfigured: this.groqAPI?.isConfigured(),
        message: message.substring(0, 50)
      });
      
      if (this.groqAPI && this.groqAPI.isConfigured()) {
        // Usar Groq API
        console.log('ü§ñ Usando Groq API...');
        const result = await this.groqAPI.sendMessage(message, this.getConversationHistory());
        
        if (result.success) {
          response = result.message;
          console.log('‚úÖ Respuesta de Groq recibida');
        } else {
          console.error('‚ùå Error de Groq:', result.error);
          throw new Error(result.error);
        }
      } else {
        // Fallback a respuestas predefinidas
        console.log('üìù Usando respuestas fallback');
        response = this.getFallbackResponse(message);
      }

      this.hideTypingIndicator();
      this.addMessage(response, 'assistant');

      // Notificar al cuervo
      if (this.raven) {
        this.raven.onChatEvent('response_received');
      }

    } catch (error) {
      console.error('Chat error:', error);
      this.hideTypingIndicator();
      this.addMessage(
        'Lo siento, hay un problema t√©cnico. Puedes contactar directamente a Edgar para ayuda. üòÖ',
        'assistant',
        true
      );

      // Notificar al cuervo
      if (this.raven) {
        this.raven.onChatEvent('error');
      }
    } finally {
      this.setLoading(false);
    }
  }

  /**
   * Agregar mensaje al chat
   */
  addMessage(content, type, isError = false) {
    const messageEl = document.createElement('div');
    messageEl.className = `message ${type} ${isError ? 'error' : ''}`;
    
    // Convertir markdown b√°sico a HTML
    const formattedContent = this.formatMessage(content);
    
    messageEl.innerHTML = `
      <div class="message-content">${formattedContent}</div>
      <div class="message-time">${this.getCurrentTime()}</div>
    `;

    this.elements.messages.appendChild(messageEl);
    this.scrollToBottom();

    // Guardar en conversaci√≥n
    if (!isError) {
      this.conversation.push({ role: type === 'user' ? 'user' : 'assistant', content });
      
      // Limitar historial
      if (this.conversation.length > this.config.maxMessages) {
        this.conversation = this.conversation.slice(-this.config.maxMessages);
      }
    }
  }

  /**
   * Mostrar indicador de escritura
   */
  showTypingIndicator() {
    const typingEl = document.createElement('div');
    typingEl.className = 'typing-indicator';
    typingEl.id = 'typing-indicator';
    
    typingEl.innerHTML = `
      <div class="typing-dots">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
      <span>Edgar AI est√° escribiendo...</span>
    `;

    this.elements.messages.appendChild(typingEl);
    this.scrollToBottom();
  }

  /**
   * Ocultar indicador de escritura
   */
  hideTypingIndicator() {
    const typingEl = document.getElementById('typing-indicator');
    if (typingEl) {
      typingEl.remove();
    }
  }

  /**
   * Configurar estado de carga
   */
  setLoading(loading) {
    this.isLoading = loading;
    this.elements.sendBtn.disabled = loading;
    this.elements.input.disabled = loading;
    this.elements.inputContainer.classList.toggle('sending', loading);
  }

  /**
   * Auto-resize del textarea
   */
  autoResizeTextarea() {
    const textarea = this.elements.input;
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 60) + 'px';
  }

  /**
   * Scroll al final del chat
   */
  scrollToBottom() {
    setTimeout(() => {
      this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
    }, 100);
  }

  /**
   * Obtener historial de conversaci√≥n
   */
  getConversationHistory() {
    return this.conversation.slice(-10); // √öltimos 10 mensajes
  }

  /**
   * Respuesta de fallback cuando no hay API - VERSI√ìN MEJORADA
   */
  getFallbackResponse(message) {
    const lowerMessage = message.toLowerCase();
    
    // ACCIONES PRINCIPALES CON FUNCIONALIDAD REAL
    if (lowerMessage.includes('descargar cv') || lowerMessage.includes('üìã descargar cv') || 
        lowerMessage.includes('curriculum') || lowerMessage.includes('cv')) {
      return this.handleCVDownload();
    }
    
    if (lowerMessage.includes('contacto directo') || lowerMessage.includes('üìß contacto directo') || 
        lowerMessage.includes('contacto') || lowerMessage.includes('email') || lowerMessage.includes('contactar')) {
      return this.handleContactInfo();
    }
    
    if (lowerMessage.includes('qu√© hace edgar') || lowerMessage.includes('üí° qu√© hace edgar') || 
        lowerMessage.includes('que hace') || lowerMessage.includes('edgar')) {
      return this.handleEdgarInfo();
    }
    
    // RESPUESTAS T√âCNICAS MEJORADAS
    const responses = {
      'hola': '¬°Hola! üëã Soy Edgar AI, tu asistente personal.\n\nüéØ **Opciones r√°pidas:**\nüìã **Descargar CV** - CV completo de Edgar\nüìß **Contacto directo** - Info para contactarlo\nüí° **Qu√© hace Edgar** - Su especialidad y experiencia\n\n¬øQu√© necesitas?',
      
      'power bi': 'üìä **Edgar es EXPERTO en Power BI:**\n\nüî• **Skills avanzados:**\n‚Ä¢ DAX complejo y optimizado\n‚Ä¢ Modelado dimensional\n‚Ä¢ Visualizaciones custom\n‚Ä¢ Performance tuning\n‚Ä¢ Row Level Security\n\nüèÜ **Proyectos destacados:**\n‚Ä¢ Dashboard Ford 2025 (15+ KPIs)\n‚Ä¢ An√°lisis DENUE Le√≥n (106K registros)\n‚Ä¢ Indicadores en tiempo real\n\nüí∞ Tarifa: $800-1,200 MXN/hora\nüìß ¬øTe interesa? Usa "Contacto directo"',
      
      'proyectos': 'üöÄ **Portfolio de Edgar - Proyectos Reales:**\n\nüöó **Dashboard Ford 2025**\n‚Ä¢ Power BI con 15+ visualizaciones\n‚Ä¢ KPIs de ventas en tiempo real\n‚Ä¢ DAX avanzado para m√©tricas complejas\n‚Ä¢ ROI: +40% eficiencia en reportes\n\nüèõÔ∏è **DENUE Le√≥n - Big Data**\n‚Ä¢ 106,844 registros analizados\n‚Ä¢ Streamlit web app interactiva\n‚Ä¢ An√°lisis geoespacial completo\n‚Ä¢ Mapas din√°micos con filtros\n\nüß† **Red Neuronal MNIST**\n‚Ä¢ TensorFlow.js en navegador\n‚Ä¢ 99.2% accuracy\n‚Ä¢ Interface web interactiva\n‚Ä¢ Demo funcional en el portafolio\n\nüìã ¬øQuieres m√°s detalles? Descarga su CV completo',
      
      'disponible': 'üìÖ **Edgar est√° DISPONIBLE:**\n\n‚úÖ **Para nuevos proyectos**\n‚ö° **Inicio inmediato**\nüïê **Respuesta < 24 horas**\n\nüíº **Modalidades:**\n‚Ä¢ Remoto (preferido)\n‚Ä¢ H√≠brido (Le√≥n, Guanajuato)\n‚Ä¢ Presencial (proyectos especiales)\n\nüí∞ **Tarifas competitivas**\nüìß Usa "Contacto directo" para cotizar'
    };
    
    // Buscar coincidencias exactas en respuestas t√©cnicas
    for (const [key, response] of Object.entries(responses)) {
      if (lowerMessage.includes(key)) {
        return response;
      }
    }

    // Respuestas por categor√≠as
    if (lowerMessage.match(/(quien|who|qui√©n)/)) {
      return '¬°Soy Edgar AI! ü§ñ Hablo sobre Edgar S√°nchez, especialista en BI y Data Science. Preg√∫ntame sobre sus proyectos, experiencia o habilidades t√©cnicas.';
    }
    
    if (lowerMessage.match(/(trabajo|job|empleo)/)) {
      return 'Edgar busca oportunidades en Business Intelligence, Data Science y desarrollo de dashboards. ¬°Perfecto para proyectos de an√°lisis de datos! üíº';
    }

    return 'ü§î **Pregunta interesante!**\n\nPuedo ayudarte con:\nüìã **"Descargar CV"** - CV completo de Edgar\nüìß **"Contacto directo"** - Informaci√≥n de contacto\nüí° **"Qu√© hace Edgar"** - Su especialidad y experiencia\n\n¬øQu√© necesitas espec√≠ficamente?';
  }

  /**
   * MANEJAR DESCARGA DE CV
   */
  handleCVDownload() {
    // Crear y ejecutar descarga inmediata del CV
    const link = document.createElement('a');
    link.href = 'assets/cvs/CV_EdgarSanchez.pdf';
    link.download = 'CV_Edgar_Sanchez_BI_DataScience.pdf';
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    return 'üìã **¬°CV descargado exitosamente!** ‚úÖ\n\nüìÑ **Edgar S√°nchez - BI & Data Science Expert**\n‚Ä¢ 3+ a√±os de experiencia\n‚Ä¢ Especialista en Power BI y Python\n‚Ä¢ Proyectos con ROI promedio 300%\n‚Ä¢ Disponible para nuevos proyectos\n\nüí° **El archivo se guard√≥ en tu carpeta de Descargas**\nüìß ¬øTe interesa contactarlo? Usa "Contacto directo"';
  }

  /**
   * MANEJAR INFORMACI√ìN DE CONTACTO
   */
  handleContactInfo() {
    // Email simple y directo
    const subject = encodeURIComponent('Contacto desde tu portafolio');
    const body = encodeURIComponent(`Hola Edgar,

Vi tu portafolio y me interesa contactarte.

Mi mensaje:
[Escribe aqu√≠ tu mensaje]

Saludos`);
    
    // Abrir email autom√°ticamente
    const mailtoLink = `mailto:edgar.sanchez.bi@gmail.com?subject=${subject}&body=${body}`;
    window.open(mailtoLink, '_blank');
    
    return 'üìß **¬°Email abierto!** ‚úÖ\n\nüì¨ **Destinatario:** edgar.sanchez.bi@gmail.com\n‚ö° **Responde en:** < 24 horas\nÔøΩ **WhatsApp:** +52 477 123 4567\n\nüí° **Solo escribe tu mensaje y env√≠a**';
  }

  /**
   * MANEJAR INFORMACI√ìN SOBRE EDGAR
   */
  handleEdgarInfo() {
    return 'üë®‚Äçüíª **Edgar S√°nchez - Business Intelligence Expert**\n\nüéØ **¬øQu√© hace?**\nTransforma datos complejos en insights accionables. Especialista en crear dashboards que impactan ROI y toma de decisiones.\n\nüõ†Ô∏è **Especialidades:**\n‚Ä¢ **Power BI Master:** DAX avanzado, modelado, performance\n‚Ä¢ **Python Expert:** Pandas, ML, automatizaci√≥n\n‚Ä¢ **Data Science:** TensorFlow, an√°lisis predictivo\n‚Ä¢ **Full Stack:** JavaScript, APIs, desarrollo web\n\nüíº **Experiencia:**\n‚Ä¢ 3+ a√±os en BI y an√°lisis\n‚Ä¢ 25+ dashboards entregados\n‚Ä¢ ROI promedio: 300% en 6 meses\n‚Ä¢ Clientes satisfechos en m√∫ltiples industrias\n\nüí∞ **Disponibilidad:**\n‚Ä¢ Empleado: $25K-35K MXN/mes\n‚Ä¢ Freelance: $15K-50K MXN/proyecto\n‚Ä¢ Por hora: $800-1,200 MXN/hr\n\nüöÄ **¬øTe interesa su perfil?**\nüìã Descarga su CV completo\nüìß Contacto directo para cotizar';
  }

  /**
   * Formatear mensaje con markdown b√°sico
   */
  formatMessage(content) {
    return content
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // **texto** -> <strong>texto</strong>
      .replace(/\n/g, '<br>') // Saltos de l√≠nea
      .replace(/‚Ä¢ /g, '<br>‚Ä¢ '); // Vi√±etas con salto de l√≠nea
  }

  /**
   * Obtener hora actual
   */
  getCurrentTime() {
    return new Date().toLocaleTimeString('es-MX', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  }

  /**
   * Configurar API key
   */
  setAPIKey(apiKey) {
    this.config.apiKey = apiKey;
    this.initializeAPI();
  }

  /**
   * Destruir el chat
   */
  destroy() {
    if (this.elements.container && this.elements.container.parentNode) {
      this.elements.container.parentNode.removeChild(this.elements.container);
    }
    
    if (this.raven) {
      this.raven.destroy();
    }
  }
}

// Exportar para uso global
window.ChatAssistant = ChatAssistant;